<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>가자도 by leisureq</title>
        <link rel="stylesheet" type="text/css" href="ax5modal.css"/>
        <link rel="stylesheet" type="text/css" href="ax5mask.css"/>
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700">
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
        <link rel="stylesheet" type="text/css" href="../stylesheets/stylesheet.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../stylesheets/v2.css" media="screen">
    </head>
    <body>
    <div id="board-container">
        <header class="header">
            <div class="header-logo">
                <img alt="가자도" title="가자도" src="https://s3.ap-northeast-2.amazonaws.com/gajado/images/gajado-v1-x1.png" />
            </div>
            <nav>
                <ul class="LBox menu-tab">
                    <li class="active"><a data-href="area">지역</a></li>
                    <li><a data-href="myarea">내주변</a></li>
                </ul>
            </nav>
        </header>

        <div class="content">
            <section class="filter-box" id="filter-view"></section>
            <section class="map-box"    id="map-view"></section>
            <section class="deal-box"   id="list-view"></section>
        </div>
    </div>
    <div class="control-btn">
        <button id="btn-show-list" class="none"></button>
        <button id="btn-show-map" class="none"></button>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/2.2.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.11.1/lodash.min.js"></script>
    <script type="text/javascript" src="https://apis.daum.net/maps/maps3.js?apikey=362020f21637d2827594370aa32c3ee4&libraries=services,clusterer"></script>
    <script type="text/javascript" src="./filter-view.js"></script>
    <script type="text/javascript" src="./list-view.js"></script>
    <script type="text/javascript" src="./map-view.js"></script>
    <script type="text/javascript" src="./spin.js"></script>
    <script type="text/javascript" src="ax5core.min.js"></script>
    <script type="text/javascript" src="ax5mask.min.js"></script>
    <script type="text/javascript" src="ax5modal.min.js"></script>

    <script type="text/javascript">
        const _spinner = (function(){
            const target = document.getElementById('board-container');
            const spinner = new Spinner({
                lines: 9 // The number of lines to draw
                , length: 42 // The length of each line
                , width: 18 // The line thickness
                , radius: 57 // The radius of the inner circle
                , scale: 0.8 // Scales overall size of the spinner
                , corners: 0.8 // Corner roundness (0..1)
                , color: '#000' // #rgb or #rrggbb or array of colors
                , opacity: 0.1 // Opacity of the lines
                , rotate: 0 // The rotation offset
                , direction: 1 // 1: clockwise, -1: counterclockwise
                , speed: 0.8 // Rounds per second
                , trail: 50 // Afterglow percentage
                , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
                , zIndex: 2e9 // The z-index (defaults to 2000000000)
                , className: 'spinner' // The CSS class to assign to the spinner
                , top: '50%' // Top position relative to parent
                , left: '50%' // Left position relative to parent
                , shadow: true // Whether to render a shadow
                , hwaccel: true // Whether to use hardware acceleration
                , position: 'absolute' // Element positioning
            });

            return {
                spin: () => {
                    spinner.spin(target);
                },
                stop: () => {
                    spinner.stop();
                }
            };
        })();

        /**@@@ tab @@@@@@@@@@@@@@@@@@@*/
        const _listView = new ListView($('#list-view'), {
            init: {
                display: false
            },
            event: {
                afterShow: () => {
                    $('#btn-show-map').show();
                    $('#btn-show-list').hide();
                }
            }
        });

        const _mapView = new MapView($('#map-view'), {
            init: {
                display: true
            },
            event: {
                afterShow: () => {
                    $('#btn-show-list').show();
                    $('#btn-show-map').hide();
                },
                fit: () => {
                    const fullHeight = $('body').innerHeight();
                    const siblingsHeight = $('header').outerHeight();

                    return {
                        width: $('body').width(),
                        height: (fullHeight - siblingsHeight)
                    };
                },
                markerClick: () => {
                    $('#btn-show-list').css('bottom', $('.map-info-window').outerHeight() + 10);
                }
            }
        });

        const _filterView = new FilterView($('#filter-view'), {
            init: {
                display: false
            },
            event: {
                select: (e) => {
                    _spinner.spin();
                    const code = $(e.target).attr('data-href');
                    $.get('https://beta.thegajago.com/map/region/' + code, function(deals){
                        console.log(deals);
                        _cachedDealResponse = deals;
                        _mapView.render(_cachedDealResponse);
                        _filterView.display(false);
                        _spinner.stop();
                    });
                }
            }
        });

        let _cachedDealResponse = {};

        $('.menu-tab a').bind("click",function(e){
            _cachedDealResponse = {}; // cache clear

            $('.menu-tab li').removeClass('active');
            $(this).parent().addClass('active');

            if ($(this).attr('data-href') == "area") {
                //지역
                _filterView.display(true);
                _listView.display(false);
                _mapView.display(false);
            } else {
                //내주변
                _filterView.display(false);
                _listView.display(false);
                _mapView.display(true);
                _spinner.spin();
                _mapView.getCurrentPosition(loadMyAreaDeals);
            }
            e.preventDefault();
        });

        //목록으로 보기
        $('#btn-show-list').click(function(e){
            e.preventDefault();
            _mapView.display(false);
            _listView.render(_cachedDealResponse);
        });

        //지도로 보기
        $('#btn-show-map').click(function(e){
            e.preventDefault();
            _listView.display(false);
            _mapView.render(_cachedDealResponse);
        });

        /**@@@ 내주변    @@@@@@@@@@@@@@@@@@@*/
        const loadMyAreaDeals = (position) => {
            if (!position) return;

            const params = { lat: position.coords.latitude, lon: position.coords.longitude };
            $.get('https://beta.thegajago.com/map/deals', params, (deals) => {
                _cachedDealResponse = {
                    list: deals,
                    centerLat: position.coords.latitude,
                    centerLon: position.coords.longitude
                }
                _listView.display(false);
                _mapView.render(_cachedDealResponse);
                _spinner.stop();
            });
        }

        $(function(){
            /** start page */
            _spinner.spin();
            $.get('https://beta.thegajago.com/map/region/01', (deals) => {
                console.log(deals);
                _cachedDealResponse = deals;
                _mapView.render(_cachedDealResponse);
                _listView.display(false);
                _filterView.display(false);
                _spinner.stop();
            });

            $('.header-logo img').click(function(){
                location.reload();
            });
        });


    </script>
    </body>
</html>
